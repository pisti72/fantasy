pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
 waiting=0
 picked=1
 falling=2
 idle=3
 ignition=4
 working=5
 holdon=6
 
 title=0
 ingame=1
 state=ingame
 p1={
  x=0,
  xv=0,
  y=0,
  yv=0,
  s=1,
  state=working}
 l={}
 smoke={}
 fuel={
 	x=rnd(120),
 	y=-rnd(128),
 	yv=1,
 	state=waiting}
 spaceship={
  x=90,
  y=104,
  state=idle,
  fuel=0,
  t=0
 }
end

function _update()
 update_player()
 update_laser()
 update_smoke()
 update_fuel()
 update_spaceship()
end

function _draw()
 cls(1)
 map()
 if p1.state==working then
 	spr(p1.s,p1.x,p1.y)
	 for l1 in all(l) do
	 	line(l1.x,l1.y,l1.x+8,l1.y,10)
	 end
	 for s in all(smoke) do
	  for i=0,s.life do
	   pset(s.x+rnd(8),s.y,8)
	  end
	 end
	end
 spr(17,fuel.x,fuel.y)
 draw_spaceship()
end

function update_laser()
 for l1 in all(l) do
  add_smoke(l1)
  l1.x+=l1.xv
 end
 for l1 in all(l) do
  if l1.x<-8 or l1.x>128 then
   del(l,l1)
  end
  if is_solid(l1) then
   del(l,l1)
  end
 end
end

function update_smoke()
 for s in all(smoke) do
  s.life-=1
  if s.life<=0 then
   del(smoke,s)
  end
 end
end

function add_smoke(l)
 local s={
 	x=l.x,
 	y=l.y,
 	life=10
 }
 add(smoke,s)
end

function add_laser()
 local xv=8
 if p1.s==2 then
  xv=-8
 end
 local l1={
  x=p1.x,
  y=p1.y+4,
  xv=xv
 }
 add(l,l1)
end

function draw_spaceship()
 local top={7,7,7,7,7,8,9,10,11}
 local bottom={23,24,25,26,27,27,27,27,27} 
 local s_top=7
 local s_bottom=23
 if spaceship.state==idle then
  s_top=top[spaceship.fuel+1]
  s_bottom=bottom[spaceship.fuel+1]
 elseif spaceship.state==waiting then
  if spaceship.t>5 then
   s_top=11
   s_bottom=27
  end
 end
 spr(s_top   ,spaceship.x,spaceship.y)
 spr(s_bottom,spaceship.x,spaceship.y+8) 	
end

function update_fuel()
 if fuel.state==picked then
  fuel.x=p1.x
  fuel.y=p1.y+4
  if abs(fuel.x-spaceship.x)<8 then
   fuel.state=falling
   fuel.x=spaceship.x
  end
 elseif fuel.state==waiting then
  if abs(p1.x-fuel.x)<8 and
   abs(p1.y-fuel.y)<8 then
   fuel.state=picked
  end
	 if not is_solid_y(fuel) then
	 	fuel.y+=fuel.yv
	 end
	elseif fuel.state==falling then
	 fuel.y+=fuel.yv
	 if fuel.y>112 then
	  spaceship.fuel+=1
	  fuel.x=rnd(110)
	  fuel.y=-50-rnd(50)
	  fuel.state=waiting
	 end
 end
end

function update_spaceship()
 if spaceship.state==idle then
	 if spaceship.fuel==8 then
	  spaceship.state=waiting
	  fuel.state=holdon
	 end
	elseif spaceship.state==waiting then
	 spaceship.t+=1
	 if spaceship.t>10 then
	  spaceship.t=0
	 end
	 if abs(p1.x-spaceship.x)<8 and
	  abs(p1.y-spaceship.y-8)<8 then
	  p1.state=ignition
	  spaceship.state=ignition
	 end
	elseif spaceship.state==ignition then
	 spaceship.y-=1
	end
end

function update_player()
 p1.xv=0
 if btn(‚û°Ô∏è) then
  p1.xv=2
  p1.s=1
 elseif btn(‚¨ÖÔ∏è) then
  p1.xv=-2
  p1.s=2
 end
 if not is_solid_x(p1) then
 	p1.x+=p1.xv
 end
 
 if p1.x<-8 then
  p1.x=128
 elseif p1.x>128 then
  p1.x=-8
 end
 
 p1.yv=1
 if btn(‚¨ÜÔ∏è) then
  p1.yv=-2
 end
 if not is_solid_y(p1) then  
 	p1.y+=p1.yv
 end
 
 if p1.y<0 then
  p1.y=0
 elseif p1.y>120 then
  p1.y=120
 end
 
 if btn(‚ùé) or btn(üÖæÔ∏è) then
  add_laser()
 end
end

function is_solid_x(obj)
 local k=fget(
  mget(
   (obj.x+obj.xv+4)/8,
   (obj.y+7)/8),0)
 return k
end

function is_solid_y(obj)
 local k=fget(
  mget(
   (obj.x+4)/8,
   (obj.y+obj.yv+7)/8),0)
 return k
end

function is_solid(obj)
 local l=fget(
  mget(
   obj.x/8,
   obj.y/8),0)
 local r=fget(
  mget(
   (obj.x+7)/8,
   obj.y/8),0)
 if l or r then
  return true
 end
 return false
end
__gfx__
0000000000777700007777000000000000000000000000000000000000067000000670000006700000067000000b300000000000000000000000000000000000
0000000000755550055557000000000000000000000000000000000000067000000670000006700000067000000b300000000000000000000000000000000000
0070070077756550056557770000000000000000000000000000000000667700006677000066770000bb330000bb330000000000000000000000000000000000
0007700077755550055557770000000000000000000000000000000000675700006757000067570000b7530000b7530000000000000000000000000000000000
00077000777777000077777700000000000000000000000000000000006557000065570000b5530000b5530000b5530000000000000000000000000000000000
00700700007770000007770000000000000000000000000000000000006777000067770000b3330000b3330000b3330000000000000000000000000000000000
000000000077700000077700000000000000000000000000000000000067770000b3330000b3330000b3330000b3330000000000000000000000000000000000
000000000070070000700700000000000000000000000000000000000067770000b3330000b3330000b3330000b3330000000000000000000000000000000000
333333333333333300000000000000000000000000000000000000000067770000677700006777000067770000b3330000000000000000000000000000000000
3b333b333113131300000000000000000000000000000000000000000067770000677700006777000067770000b3330000000000000000000000000000000000
5444444431331113000000000000000000000000000000000000000000677700006777000067770000b3330000b3330000000000000000000000000000000000
445444543333333300000000000000000000000000000000000000000667777006677770066777700bb333300bb3333000000000000000000000000000000000
444454443113133300000000000000000000000000000000000000006667777766677777bbb33333bbb33333bbb3333300000000000000000000000000000000
444444443133133300000000000000000000000000000000000000006666667766666677bbbbbb33bbbbbb33bbbbbb3300000000000000000000000000000000
4444444431131113000000000000000000000000000000000000000066000077bb0000bbbb0000bbbb0000bbbb0000bb00000000000000000000000000000000
5555555533333333000000000000000000000000000000000000000060000007b000000bb000000bb000000bb000000b00000000000000000000000000000000
__gff__
0000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010101010000000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010101010000000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
